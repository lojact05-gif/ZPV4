name: Build Zaldo Printer Installer

on:
  workflow_dispatch:
  push:
    paths:
      - "tools/zaldo_printer/**"
      - "zaldo_printer/**"
      - "/**"
      - ".github/workflows/build-zaldo-printer.yml"

jobs:
  build-installer:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve project path
        id: resolve
        run: |
          $target = Get-ChildItem -Path . -Recurse -File -Filter build.ps1 |
            Where-Object { $_.FullName -match '[\\/]+zaldo_printer[\\/]+scripts[\\/]+build\.ps1$' } |
            Select-Object -First 1

          if (-not $target) {
            Write-Host "No build.ps1 found under any '/scripts' path."
            Write-Host "Top-level repository content:"
            Get-ChildItem -Force | Select-Object Name, Mode
            throw "Missing printer project files in repository checkout."
          }

          $scriptsDir = Split-Path -Path $target.FullName -Parent
          $resolved = Split-Path -Path $scriptsDir -Parent
          Write-Host "Resolved printer root: $resolved"
          "printer_root=$resolved" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y

      - name: Build binaries
        run: |
          Set-Location "${{ steps.resolve.outputs.printer_root }}/scripts"
          ./build.ps1 -Configuration Release -Runtime win-x64 -SelfContained:$true

      - name: Build installer
        run: |
          Set-Location "${{ steps.resolve.outputs.printer_root }}/scripts"
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (!(Test-Path $iscc)) {
            throw "ISCC not found at '$iscc'."
          }
          ./build_installer.ps1 -InnoPath $iscc

      - name: Generate checksum
        run: |
          $setup = "${{ steps.resolve.outputs.printer_root }}/dist/ZaldoPrinterSetup.exe"
          if (!(Test-Path $setup)) {
            throw "Installer not found: $setup"
          }
          Get-FileHash $setup -Algorithm SHA256 |
            ForEach-Object { "$($_.Hash.ToLower())  ZaldoPrinterSetup.exe" } |
            Out-File -FilePath "${{ steps.resolve.outputs.printer_root }}/dist/ZaldoPrinterSetup.sha256" -Encoding ascii

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: zaldo-printer-installer
          path: |
            ${{ steps.resolve.outputs.printer_root }}/dist/ZaldoPrinterSetup.exe
            ${{ steps.resolve.outputs.printer_root }}/dist/ZaldoPrinterSetup.sha256
          if-no-files-found: error
          retention-days: 14
